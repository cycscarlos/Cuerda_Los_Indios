<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control Genealógico - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/cart_modal.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- D3.js -->
  </head>
  <body class="page-genealogy">
    <!-- Navbar Placeholder -->
    <nav id="navbar-placeholder" style="min-height: 80px"></nav>

    <header class="section">
      <div class="container">
        <h1>Registro Genealógico</h1>
        <p>Panel administrativo para ingreso de nuevos ejemplares.</p>
      </div>
    </header>

    <section class="section section-no-top">
      <div class="container">
        <div class="admin-panel">
          <h2>Registrar Nuevo Ejemplar</h2>
          <form id="genealogyForm">
            <div class="form-group">
              <label for="g-name">Nombre del Ejemplar</label>
              <input type="text" id="g-name" class="input-field" required />
            </div>
            <div class="form-group">
              <label for="g-gender">Género</label>
              <select id="g-gender" class="input-field">
                <option value="Macho">Macho</option>
                <option value="Hembra">Hembra</option>
              </select>
            </div>
            <div class="flex-gap-1">
              <div class="form-group flex-1">
                <label for="g-father">Padre</label>
                <input
                  type="text"
                  id="g-father"
                  class="input-field"
                  placeholder="Nombre del Padre"
                />
              </div>
              <div class="form-group flex-1">
                <label for="g-mother">Madre</label>
                <input
                  type="text"
                  id="g-mother"
                  class="input-field"
                  placeholder="Nombre de la Madre"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="g-line">Línea Genética</label>
              <input
                type="text"
                id="g-line"
                class="input-field"
                placeholder="Ej. Kelso / Sweater"
              />
            </div>
            <button type="submit" class="btn btn-primary">
              Guardar Registro
            </button>
          </form>
        </div>

        <div class="records-list">
          <h2>Registros Recientes</h2>
          <ul id="recent-records">
            <!-- JS population mockup -->
            <li class="record-item">Cargando...</li>
          </ul>
        </div>

        <!-- Tree Container -->
        <div
          id="tree-container"
          style="margin-top: 2rem; width: 100%; height: 400px"
        ></div>
      </div>
    </section>

    <!-- Footer Placeholder -->
    <footer id="footer-placeholder"></footer>

    <script type="module" src="js/main.js"></script>

    <script type="module">
      import ApiService from "./js/modules/ApiService.js";
      import GenealogyTree from "./js/modules/GenealogyTree.js";

      document.addEventListener("DOMContentLoaded", async () => {
        const list = document.getElementById("recent-records");
        const api = new ApiService();
        const tree = new GenealogyTree("tree-container");

        try {
          const roosters = await api.getRoosters();

          // Render List
          list.innerHTML = "";
          if (roosters.length === 0) {
            list.innerHTML = '<li class="record-item">No hay registros.</li>';
          } else {
            roosters.forEach((d) => {
              list.innerHTML += `<li class="record-item">
                            <strong>${d.name}</strong> (${d.gender}) - Placa: ${
                d.plate || "N/A"
              }
                        </li>`;
            });
          }

          // Render Tree (Pass all data for now)
          tree.render(roosters);
        } catch (e) {
          console.error(e);
          list.innerHTML = `<li class="record-item text-danger">Error: ${
            e.message || e.error_description || JSON.stringify(e)
          }</li>`;
        }
      });

      document
        .getElementById("genealogyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;

          const roosterData = {
            name: form.querySelector("#g-name").value,
            gender: form.querySelector("#g-gender").value,
            strain: form.querySelector("#g-line").value,
            // For now, genealogy page form mock-ups for parents are just strings,
            // but our DB expects IDs. In a real scenario we'd need search/select for parents here too.
            // For this step, we'll insert just the text into 'name' and 'strain' and leave parents null
            // unless we implement the full search UI here.
            // To respect the user constraint of "Input", we will save what we can.
            status: "Disponible",
          };

          try {
            const api = new ApiService();
            await api.createRooster(roosterData);
            alert("Registro Guardado Correctamente");
            form.reset();
            // Reload list
            window.location.reload();
          } catch (err) {
            console.error(err);
            alert("Error al guardar: " + err.message);
          }
        });
    </script>
  </body>
</html>
