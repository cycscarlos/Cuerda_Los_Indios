<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administración - Cuerda Los Indios</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <script>
    // Immediate Security Check
    const user = localStorage.getItem("user");
    if (!user) {
      window.location.href = "login.html";
    }
  </script>
  <body class="page-inventory">
    <!-- Navbar Placeholder -->
    <nav id="navbar-placeholder" style="min-height: 80px"></nav>

    <div class="container admin-container">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <h3 class="admin-sidebar-header">Admin Menu</h3>
        <ul class="admin-menu-list">
          <li class="admin-menu-item">
            <a href="inventory.html" class="admin-menu-link">
              <i class="fas fa-boxes"></i> Inventario
            </a>
          </li>
          <li class="admin-menu-item">
            <a href="#" class="admin-menu-link active">
              <i class="fas fa-dna"></i> Registrar Cría
            </a>
          </li>
          <!-- Future: Sales, Users, etc. -->
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="admin-main">
        <header class="admin-header">
          <h1>Registro de Nuevos Ejemplares</h1>
          <p class="text-muted">
            Utilice este formulario para ingresar nuevas crías al sistema
            genealógico.
          </p>
        </header>

        <div class="admin-panel" style="margin: 0; max-width: 100%">
          <h2>Datos del Ejemplar</h2>
          <form id="genealogyForm">
            <div class="form-group">
              <label for="g-plate">Placa / ID *</label>
              <input
                type="text"
                id="g-plate"
                class="input-field"
                required
                placeholder="Ej. 1045"
              />
            </div>
            <div class="form-group">
              <label for="g-name">Nombre del Ejemplar</label>
              <input type="text" id="g-name" class="input-field" required />
            </div>
            <div class="form-group">
              <label for="g-gender">Género</label>
              <select id="g-gender" class="input-field">
                <option value="Macho">Macho</option>
                <option value="Hembra">Hembra</option>
              </select>
            </div>

            <div class="form-group">
              <label for="g-line">Línea Genética</label>
              <input
                type="text"
                id="g-line"
                class="input-field"
                placeholder="Ej. Kelso / Sweater"
              />
            </div>

            <div class="flex-gap-1">
              <div class="form-group flex-1">
                <label for="g-father">Padre (ID/Nombre)</label>
                <input
                  type="text"
                  id="g-father"
                  class="input-field"
                  placeholder="Buscar Padre..."
                />
              </div>
              <div class="form-group flex-1">
                <label for="g-mother">Madre (ID/Nombre)</label>
                <input
                  type="text"
                  id="g-mother"
                  class="input-field"
                  placeholder="Buscar Madre..."
                />
              </div>
            </div>

            <button type="submit" class="btn btn-primary">
              Guardar Registro
            </button>
          </form>
        </div>

        <div class="records-list recent-records-container">
          <h3>Registros Recientes</h3>
          <ul id="recent-records" class="recent-records-list">
            <!-- JS population mockup -->
            <li class="record-item">Cargando...</li>
          </ul>
        </div>
      </main>
    </div>

    <!-- Footer Placeholder -->
    <footer id="footer-placeholder"></footer>

    <script type="module" src="js/main.js"></script>

    <script type="module">
      import ApiService from "./js/modules/ApiService.js";

      document.addEventListener("DOMContentLoaded", async () => {
        // Security Check is handled in main.js, but we can double check here
        /*
            if (!localStorage.getItem('user')) {
                window.location.href = 'login.html';
            }
            */

        const list = document.getElementById("recent-records");
        const api = new ApiService();

        // Load Recent
        try {
          const roosters = await api.getRoosters();
          list.innerHTML = "";
          // Show last 5
          roosters.slice(0, 5).forEach((d) => {
            list.innerHTML += `<li class="record-item">
                        <strong>${d.name || "Sin Nombre"}</strong> (${
              d.strain || "N/A"
            }) - Placa: ${d.plate || "N/A"}
                    </li>`;
          });
        } catch (e) {
          console.error(e);
        }
      });

      // Form Handler
      document
        .getElementById("genealogyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const api = new ApiService();

          const roosterData = {
            plate: form.querySelector("#g-plate").value, // Added Plate
            name: form.querySelector("#g-name").value,
            gender: form.querySelector("#g-gender").value,
            strain: form.querySelector("#g-line").value,
            status: "Disponible",
          };

          if (!roosterData.plate) {
            alert("Por favor ingrese el número de PLACA.");
            return;
          }

          try {
            await api.createRooster(roosterData);
            alert("Registro Guardado Correctamente");
            form.reset();
            window.location.reload();
          } catch (err) {
            alert("Error al guardar: " + err.message);
          }
        });
    </script>
  </body>
</html>
